version: '3.1'

services:  

  smics_core:
    build:
        context: .
    container_name: smics_core
    volumes:
      - /home/smics/.aspnet/https/:/root/app/Certificates/
    environment:
      - OPENEHR_DB=https://medic-c-t.mh-hannover.local:8083/rest/openehr/v1
      - AUTHORITY=https://keycloak.mh-hannover.local:8443/auth/realms/Better
      - CLIENT_ID=medic-c-t
      #- CLIENT_SECRET=null
      - ASPNETCORE_URLS=https://+;http://+
      - ASPNETCORE_HTTPS_PORT=443
      - ASPNETCORE_Kestrel__Certificates__Default__Password=4xftuxtO7tbn
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/root/app/Certificates/smics.pfx
    ports:
      - 80:80
      - 443:443
    networks: 
        - smics-net

  smics_visualisierung:
    depends_on: 
      - smics_core
    build: ../SmICSVisualisierung
    environment:
      - DEV_MODE=true
      - USE_AUTH=true
      - SMICS_HOSTNAME=smics.mh-hannover.local
      - SMICS_PORT=443
      - AUTH_PROVIDER_URL=https://keycloak.mh-hannover.local:8443
      - AUTH_REALM=Better
      - AUTH_CLIENT_ID=medic-c-t
      - HTTPS_METHOD=noredirect
      #- AUTH_CLIENT_SECRET=
    ports:
      - 3231:3231
    container_name: smics_visualisierung
    networks: 
     - smics-net
     - nginx-net

  nginx:
    image: nginx:mainline-alpine
    container_name: nginx
    restart: unless-stopped
    ports: 
      - 8080:80
      - 8443:443
    depends_on:
      - smics_visualisierung
    networks:
      - nginx-net
    volumes:
      - ../SmICSVisualisierung/nginx-conf:/etc/nginx/conf.d
      - ../certs/:etc/ssl/
networks:
  smics-net: {}
  nginx-net: {}

